Да, у тебя «малый трейн» из-за недельного блочного сплита+purge при короткой истории (c 2025-11-06). Лечится не «магией модели», а разметкой/сплитом. Делай вот так — минимум правок.

Что поменять, чтобы трейн стал больше

Сменить weekly-split на daily-split и убрать purge.
Сейчас freq='W-MON' и purge_periods=1 съедают почти всё, когда данных всего на несколько дней.
Поставь:

split_info = blocked_time_split(
    news, ts_col='published_at',
    test_frac=0.20,          # оставь 20% дней под тест
    freq='D',                # ДНЕВНЫЕ блоки вместо недельных
    purge_periods=0          # без «буфера» между train/test
)


Это сразу даст нормальный train за первые дни и тест — последние дни.

    Подними лимит на «свалки» новостей, чтобы не отбрасывать тысячи строк.
    Лог показывал «Filtered news piles >20: 9015 removed» — при коротком окне это чересчур агрессивно.
    Вверху файла поменяй:

NEWS_PILE_THRESHOLD = 80  # было 20

(Потом, когда вернёшься к длинной истории, можно снова опустить до 20–30.)

    Чуть ослабь фильтр динамического горизонта.
    Чтобы меньше терять событий:

MIN_H = 3   # было 5

Это добавит ивентов, у которых «следующая новость того же типа» пришла через 3–5 минут.

    Страховка на случай, если train всё равно мал.
    Сразу после blocked_time_split(...) добавь простой автодауншифт:

if split_info is not None:
    train_mask_all = split_info['train_mask']
    if train_mask_all.sum() < 300:   # целевой минимум
        logging.info("Train too small (%d). Switching to daily split, no purge, test_frac=0.15",
                     train_mask_all.sum())
        split_info = blocked_time_split(news, ts_col='published_at',
                                        test_frac=0.15, freq='D', purge_periods=0)
                                        
                                        
Что НЕ трогать сейчас

    Пороги разметки направления (THR_MIN_PIPS=1.8, THR_COEFF=0.60) оставь — они уже чистят шумиху; увеличение сэмплов добиваем сплитом/фильтром, а не ослаблением меток.

    Исключение te_stock_* — оставь исключёнными, чтобы не замусорить FX-задачу.

К чему прийти после правок

    Train станет в разы больше (первые дни уйдут в train, последние — в test).

    Coverage в «confidence-срезах» вырастет; начнёшь подбирать conf/margin уже на разумных n.

    Trade-gate пока держи без p_move (или хотя бы не требуй p_move ≥ 0.68 одновременно с conf и margin). Сначала добейся стабильного win-rate по чистому conf≥0.72–0.75 & margin≥0.10, потом вернёшь 2-stage.

Если коротко: сделай freq='D', purge_periods=0, подними NEWS_PILE_THRESHOLD и снизь MIN_H до 3. Это максимум данных без порчи домена.










19:58
# —— Разметка направления
THR_MIN_PIPS = 1.8          # нижний порог в пипсах
THR_COEFF    = 0.60         # коэффициент * предволы 15м
USE_VOL_QUANTILE = False    # квантильный режим порога выкл
VOL_QUANTILE = 0.70         # если включишь квантильный режим

# —— Динамический горизонт окна
MAX_H_MIN = 60              # максимум до t+dyn
MIN_H_MIN = 3               # минимум (снизили до 3 минут)

# —— Анти-«свалки» на один timestamp
NEWS_PILE_THRESHOLD = 80    # жёсткий отсек крупной свалки
MAX_EVENTS_PER_TIMESTAMP = 60   # мягкий каппинг: оставляем топ-60 по fx_weight

# —— Сплит (трен/тест)
SPLIT_MODE = "events"       # "events" | "periods" | "quantile"
SPLIT_FREQ = "D"            # шаг периодов (для "events"/"periods")
TEST_EVENT_FRAC  = 0.15     # доля событий в тесте (цель — 12–18%)
TEST_PERIOD_FRAC = 0.20     # если выберешь "periods"
PURGE_PERIODS    = 0        # сан.зона между train/test (пока 0 — данных мало)

# —— Бусты классов/событий
BOOST_DOWN = 1.35
BOOST_NEU  = 1.00
BOOST_UP   = 2.10
SINGLETON_BOOST_MAX = 1.30  # потолок буста одиночных событий

# —— Трейд-гейты
CONF_GATE       = 0.72      # минимальная уверенность (max prob)
MOVE_GATE_TRADE = 0.68      # вероятность «есть движение»
MARGIN_GATE     = 0.10      # разрыв между топ-1 и топ-2 вероятностями
MOVE_GATE_2STAGE = 0.60     # порог «движение» для 2-стадии

# —— Прочее
EXCLUDE_PREFIXES = ('te_stock_market_', 'te_stocks_')
DROP_CONST_FEATURES_MIN_NUNIQUE = 2

    Если захочется жестче отсеивать «свалки», уменьши MAX_EVENTS_PER_TIMESTAMP до 40; если нужно добрать трейн — подними TEST_EVENT_FRAC до 0.18.

2025-11-11 21:18:10,197Z - INFO - ==== TE V5 Trainer start ====
2025-11-11 21:18:10,197Z - INFO - Connecting DB...
2025-11-11 21:18:10,256Z - INFO - DB OK
2025-11-11 21:18:10,256Z - INFO - Config dump: split_mode=events freq=D test_event_frac=0.15 test_period_frac=0.20 max_events_per_ts=60 thr_min=1.80 thr_coeff=0.60 use_vol_quantile=False vol_q=0.70 min_h=3 max_h=60 gates(conf=0.72 move_trade=0.68 margin=0.10 move_2stage=0.60)
2025-11-11 21:18:10,256Z - INFO - Loading prices...
2025-11-11 21:20:03,079Z - INFO - Indicators (RSI/SMA/ATR)...
2025-11-11 21:20:06,702Z - INFO - Daily trends (SMA/trend)...
2025-11-11 21:20:08,231Z - INFO - Loading TE news...
2025-11-11 21:20:08,598Z - INFO - Applying event filters in order: exclude prefixes -> cap per timestamp -> drop piles >80
2025-11-11 21:20:08,610Z - INFO - Excluded 680 stock-related events with prefixes ('te_stock_market_', 'te_stocks_')
2025-11-11 21:20:08,655Z - INFO - Capped per-timestamp events to 60: kept 2981, dropped 7271
2025-11-11 21:20:08,656Z - INFO - No timestamps exceeded NEWS_PILE_THRESHOLD=80
2025-11-11 21:20:08,656Z - INFO - Loading imp_cache_tradingeconomics...
2025-11-11 21:20:08,844Z - INFO - Building targets (direction/magnitude) with +15m horizon...
2025-11-11 21:20:10,882Z - INFO - Dynamic horizon filter: 2981 -> 884 events (removed 2097 with horizon < 3m)
2025-11-11 21:20:11,390Z - INFO - Direction classification thresholds: linear thr_min=1.80 coeff=0.60
2025-11-11 21:20:11,391Z - INFO - Threshold range (linear): min=1.80 max=2.04 median=1.80
2025-11-11 21:20:11,391Z - INFO - Building features...
2025-11-11 21:20:11,406Z - INFO - Loading correlation features...
2025-11-11 21:20:11,522Z - INFO - Falling back to correlation_trends (currency/year).
2025-11-11 21:20:11,553Z - INFO - Applied currency/year correlation fallback.
2025-11-11 21:20:12,503Z - INFO - Labels: use_dynamic=False, y_col=direction_cls, mag_col=magnitude_pips
2025-11-11 21:20:12,586Z - INFO - Preparing train/test split: mode=events freq=D
2025-11-11 21:20:12,593Z - INFO - Blocked split mode=events freq=D train_periods=['2025-10-06', '2025-10-08', '2025-10-09', '2025-10-10', '2025-10-12', '2025-10-13', '2025-10-14', '2025-10-15', '2025-10-16', '2025-10-17', '2025-10-19', '2025-10-20', '2025-10-21', '2025-10-22', '2025-10-23', '2025-10-24', '2025-10-26', '2025-10-27', '2025-10-28', '2025-10-29', '2025-10-30', '2025-10-31', '2025-11-02', '2025-11-03', '2025-11-04', '2025-11-05', '2025-11-06', '2025-11-07', '2025-11-09'] test_periods=['2025-11-10', '2025-11-11'] purge=[]
2025-11-11 21:20:12,597Z - INFO - Split result mode=events freq=D: train=699 (79.07%) test=185 (20.93% target=15.00%) purge_removed=0
2025-11-11 21:20:12,598Z - INFO - Overall class distribution after filtering: counts=[168, 408, 308] share=[0.19, 0.4615, 0.3484]
2025-11-11 21:20:12,603Z - INFO - Time split @ 2025-11-10 00:00:00: train=699, test=185
2025-11-11 21:20:12,604Z - INFO - Class balance (train): Counter({np.int64(1): 299, np.int64(2): 268, np.int64(0): 132})
2025-11-11 21:20:12,604Z - INFO - Class share (train): [0.1888, 0.4278, 0.3834]
2025-11-11 21:20:12,605Z - INFO - Class balance (test): Counter({np.int64(1): 109, np.int64(2): 40, np.int64(0): 36})
2025-11-11 21:20:12,605Z - INFO - Class share (test): [0.1946, 0.5892, 0.2162]
2025-11-11 21:20:12,605Z - INFO - Baseline (majority=1) acc=0.5892
2025-11-11 21:20:12,605Z - INFO - Train RandomForest (direction)...
2025-11-11 21:20:13,676Z - INFO - GridSearch XGBClassifier (direction)...
2025-11-11 21:22:15,597Z - INFO - Best XGB params: {'learning_rate': 0.05, 'max_depth': 4, 'n_estimators': 200}
2025-11-11 21:22:15,733Z - INFO - Pred counts (raw): [87, 96, 2]
2025-11-11 21:22:15,734Z - INFO - Avg probs (raw p0,p1,p2): [0.3793, 0.4534, 0.1673]
2025-11-11 21:22:15,734Z - INFO - Train priors: [0.1888, 0.4278, 0.3834], alpha disabled
2025-11-11 21:22:15,734Z - INFO - Avg probs (raw p0,p1,p2): [0.3793, 0.4534, 0.1673]
2025-11-11 21:22:15,735Z - INFO - Pred counts (adj+margin): [81, 96, 8]
2025-11-11 21:22:15,737Z - INFO - 
Confusion matrix [rows=true (0,1,2), cols=pred]:
[[20 14  2]
 [41 65  3]
 [20 17  3]]
2025-11-11 21:22:15,746Z - INFO - 
              precision    recall  f1-score   support

           0      0.247     0.556     0.342        36
           1      0.677     0.596     0.634       109
           2      0.375     0.075     0.125        40

    accuracy                          0.476       185
   macro avg      0.433     0.409     0.367       185
weighted avg      0.528     0.476     0.467       185

2025-11-11 21:22:15,748Z - INFO - Per-class recall: [0.556, 0.596, 0.075]
2025-11-11 21:22:15,749Z - INFO - Ensemble (RF+XGB) direction: acc=0.4757 f1=0.3670
2025-11-11 21:22:15,752Z - INFO - FX-only subset: n=185 share=100.00% acc=0.4757 macroF1=0.3670
2025-11-11 21:23:26,112Z - INFO - 
[2-stage] Confusion (0,1,2 rows vs cols):
[[17 16  3]
 [29 78  2]
 [19 15  6]]
2025-11-11 21:23:26,113Z - INFO - [2-stage] acc=0.5459 macroF1=0.4292 move_cov=0.41
2025-11-11 21:23:26,113Z - INFO - 
=== Confidence-based filtering ===
2025-11-11 21:23:26,115Z - INFO - Conf>=0.50: coverage=74.59% n=138 acc=0.529 f1=0.386
2025-11-11 21:23:26,118Z - INFO - Conf>=0.55: coverage=53.51% n= 99 acc=0.586 f1=0.390
2025-11-11 21:23:26,120Z - INFO - Conf>=0.60: coverage=36.76% n= 68 acc=0.632 f1=0.408
2025-11-11 21:23:26,123Z - INFO - Conf>=0.65: coverage=22.16% n= 41 acc=0.780 f1=0.465
2025-11-11 21:23:26,125Z - INFO - Conf>=0.70: coverage=15.68% n= 29 acc=0.966 f1=0.333
2025-11-11 21:23:26,128Z - INFO - Conf>=0.75: coverage=15.14% n= 28 acc=1.000 f1=1.000
2025-11-11 21:23:26,128Z - INFO - 
=== Trade gate (FX-only) ===
2025-11-11 21:23:26,128Z - INFO - Trade gate thresholds: conf>=0.72, p_move>=0.68, margin>=0.10
2025-11-11 21:23:26,128Z - INFO - Trade gate: no predictions passed thresholds (coverage=0.00%)
2025-11-11 21:23:26,128Z - INFO - Acceptance check: overall_ok=False (macroF1=0.367, recall2=0.075) trade_ok=False (cov=0.000 acc=None)
2025-11-11 21:23:26,128Z - INFO - Criteria not met -> scanning threshold/gate grid (no retraining, what-if analysis)
2025-11-11 21:23:26,416Z - INFO - Best grid combo: thr_min=1.80 thr_coeff=0.55 conf=0.70 move=0.60 margin=0.05 | f1=0.367 recall2=0.075 cov=0.005 acc_trade=0.000 f1_trade=0.000 main_ok=False gate_ok=False
2025-11-11 21:23:26,416Z - INFO - 
=== Performance by event type (top 10) ===
2025-11-11 21:23:26,426Z - INFO - 
Top 10 best performing events:
2025-11-11 21:23:26,427Z - INFO -   te_currency_united_states: acc=0.667 (2/3) avg_delta=-0.37 avg_delta_dyn=-1.00 avg_mag=0.77
2025-11-11 21:23:26,427Z - INFO -   te_misc_commodity: acc=0.449 (22/49) avg_delta=-0.85 avg_delta_dyn=+0.28 avg_mag=2.21
2025-11-11 21:23:26,427Z - INFO -   te_misc_currency: acc=0.444 (4/9) avg_delta=+0.07 avg_delta_dyn=-0.38 avg_mag=1.42
2025-11-11 21:23:26,427Z - INFO -   te_government_bond_10y_united_states: acc=0.333 (1/3) avg_delta=-2.53 avg_delta_dyn=-5.13 avg_mag=2.53
2025-11-11 21:23:26,428Z - INFO - 
Bottom 10 worst performing events:
2025-11-11 21:23:26,428Z - INFO -   te_currency_united_states: acc=0.667 (2/3) avg_delta=-0.37 avg_delta_dyn=-1.00 avg_mag=0.77
2025-11-11 21:23:26,428Z - INFO -   te_misc_commodity: acc=0.449 (22/49) avg_delta=-0.85 avg_delta_dyn=+0.28 avg_mag=2.21
2025-11-11 21:23:26,428Z - INFO -   te_misc_currency: acc=0.444 (4/9) avg_delta=+0.07 avg_delta_dyn=-0.38 avg_mag=1.42
2025-11-11 21:23:26,429Z - INFO -   te_government_bond_10y_united_states: acc=0.333 (1/3) avg_delta=-2.53 avg_delta_dyn=-5.13 avg_mag=2.53
2025-11-11 21:23:26,429Z - INFO - 
=== FX-only performance (event types, top 10) ===
2025-11-11 21:23:26,433Z - INFO -   te_currency_united_states: acc=0.667 (2/3) avg_delta=-0.37
2025-11-11 21:23:26,434Z - INFO -   te_misc_commodity: acc=0.449 (22/49) avg_delta=-0.85
2025-11-11 21:23:26,434Z - INFO -   te_misc_currency: acc=0.444 (4/9) avg_delta=+0.07
2025-11-11 21:23:26,434Z - INFO -   te_government_bond_10y_united_states: acc=0.333 (1/3) avg_delta=-2.53
2025-11-11 21:23:26,587Z - INFO - GridSearch XGBRegressor (magnitude)...
2025-11-11 21:23:57,792Z - INFO - Best XGBReg params: {'learning_rate': 0.05, 'max_depth': 6, 'n_estimators': 200}
2025-11-11 21:24:27,416Z - INFO - RMSE magnitude (pips) @+15m: 2.5827
2025-11-11 21:24:27,429Z - INFO - ==== TE V5 Trainer done ====
